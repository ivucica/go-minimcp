#!/usr/bin/expect
log_user 1
set timeout 5
set stty_init raw ; # Required for \r\n to work correctly for Content-Length.
spawn $env(GOPATH)/bin/minimcp

set REQ "{  \"jsonrpc\": \"2.0\",   \"id\": 1,   \"method\": \"initialize\",   \"params\": {     \"protocolVersion\": \"2024-11-05\",     \"capabilities\": {       \"roots\": {         \"listChanged\": true       },       \"sampling\": {},       \"elicitation\": {}     },     \"clientInfo\": {       \"name\": \"ExampleClient\",       \"title\": \"Example Client Display Name\",       \"version\": \"1.0.0\"     }   } }"

# one line per request, one line per response, per spec
send -raw -- "$REQ\n"

expect {
  timeout { puts "timed out waiting for response"; exit 1 }
  -regexp "{\"id\":1,\"result\":(.*),\"jsonrpc\":\"2.0\"}\n" {
    exec ./_test_jq.sh "$expect_out(1,string)"
  }
  eof { puts "EOF reached before expected response"; exit 2 }
}
expect {
  timeout { puts "timed out waiting for response"; exit 1 }
  -regexp "notif" {
    exit 0 ; # TODO: add correct check for notifications, {"jsonrpc":"2.0","method":"notification/initialized"}
  }
  eof { puts "EOF reached before expected response"; exit 2 }
}
